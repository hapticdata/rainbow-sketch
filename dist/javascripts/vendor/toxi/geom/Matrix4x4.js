define(["require","exports","module","../math/mathUtils","./Vec3D","../internals"],function(t,e,i){var n=t("../math/mathUtils"),r=t("../internals"),s=t("./Vec3D"),o=function(t,e,i,n,s,o,a,u,h,c,l,d,f,p,m,g){this.temp=[],this.matrix=[];var _=this;if(0===arguments.length)this.matrix[0]=[1,0,0,0],this.matrix[1]=[0,1,0,0],this.matrix[2]=[0,0,1,0],this.matrix[3]=[0,0,0,1];else if("number"==typeof t){var y=[t,e,i,n],x=[s,o,a,u],v=[h,c,l,d],b=[f,p,m,g];this.matrix=[y,x,v,b]}else if(r.tests.isArray(t)){var w=t;if(9!=w.length&&16!=w.length)throw Error("Matrix4x4: Array length must == 9 or 16");16==w.length?(this.matrix=[],this.matrix[0]=w.slice(0,4),this.matrix[1]=w.slice(4,8),this.matrix[2]=w.slice(8,12),this.matrix[3]=w.slice(12)):(this.matrix[0]=w.slice(0,3),this.matrix[0][3]=0/0,this.matrix[1]=w.slice(3,6),this.matrix[1][3]=0/0,this.matrix[2]=w.slice(6,9),this.matrix[2][3]=0/0,this.matrix[3]=[0/0,0/0,0/0,0/0])}else if(r.tests.isMatrix4x4(t)){var E,C,A=t,S=0,M=0;if(16==A.matrix.length)for(S=0;4>S;S++)this.matrix[S]=[A.matrix[S][0],A.matrix[S][1],A.matrix[S][2],A.matrix[S][3]];else if(4==A.matrix.length)for(E=A.matrix.length,S=0;E>S;S++)for(C=A.matrix[S].length,_.matrix[S]=[],M=0;C>M;M++)_.matrix[S][M]=A.matrix[S][M]}else console.error("Matrix4x4: incorrect parameters used to construct new instance")};o.prototype={add:function(t){var e=new o(this);return e.addSelf(t)},addSelf:function(t){for(var e=0;4>e;e++){var i=this.matrix[e],n=t.matrix[e];i[0]+=n[0],i[1]+=n[1],i[2]+=n[2],i[3]+=n[3]}return this},applyTo:function(t){return this.applyToSelf(new s(t))},applyToSelf:function(t){for(var e=0;4>e;e++){var i=this.matrix[e];this.temp[e]=t.x*i[0]+t.y*i[1]+t.z*i[2]+i[3]}return t.set(this.temp[0],this.temp[1],this.temp[2]).scaleSelf(1/this.temp[3]),t},copy:function(){return new o(this)},getInverted:function(){return new o(this).invert()},getRotatedAroundAxis:function(t,e){return new o(this).rotateAroundAxis(t,e)},getRotatedX:function(t){return new o(this).rotateX(t)},getRotatedY:function(t){return new o(this).rotateY(t)},getRotatedZ:function(t){return new o(this).rotateZ(t)},getTransposed:function(){return new o(this).transpose()},identity:function(){var t=this.matrix[0];return t[1]=t[2]=t[3]=0,t=this.matrix[1],t[0]=t[2]=t[3]=0,t=this.matrix[2],t[0]=t[1]=t[3]=0,t=this.matrix[3],t[0]=t[1]=t[2]=0,this.matrix[0][0]=1,this.matrix[1][1]=1,this.matrix[2][2]=1,this.matrix[3][3]=1,this},invert:function(){var t=[],e=[],i=[],n=this.toArray(),r=0;for(r=0;4>r;r++){var s=r<<2;e[r]=n[s],e[r+4]=n[s+1],e[r+8]=n[s+2],e[r+12]=n[s+3]}t[0]=e[10]*e[15],t[1]=e[11]*e[14],t[2]=e[9]*e[15],t[3]=e[11]*e[13],t[4]=e[9]*e[14],t[5]=e[10]*e[13],t[6]=e[8]*e[15],t[7]=e[11]*e[12],t[8]=e[8]*e[14],t[9]=e[10]*e[12],t[10]=e[8]*e[13],t[11]=e[9]*e[12];var o=e[0],a=e[1],u=e[2],h=e[3],c=e[4],l=e[5],d=e[6],f=e[7];i[0]=t[0]*l+t[3]*d+t[4]*f,i[0]-=t[1]*l+t[2]*d+t[5]*f,i[1]=t[1]*c+t[6]*d+t[9]*f,i[1]-=t[0]*c+t[7]*d+t[8]*f,i[2]=t[2]*c+t[7]*l+t[10]*f,i[2]-=t[3]*c+t[6]*l+t[11]*f,i[3]=t[5]*c+t[8]*l+t[11]*d,i[3]-=t[4]*c+t[9]*l+t[10]*d,i[4]=t[1]*a+t[2]*u+t[5]*h,i[4]-=t[0]*a+t[3]*u+t[4]*h,i[5]=t[0]*o+t[7]*u+t[8]*h,i[5]-=t[1]*o+t[6]*u+t[9]*h,i[6]=t[3]*o+t[6]*a+t[11]*h,i[6]-=t[2]*o+t[7]*a+t[10]*h,i[7]=t[4]*o+t[9]*a+t[10]*u,i[7]-=t[5]*o+t[8]*a+t[11]*u,t[0]=u*f,t[1]=h*d,t[2]=a*f,t[3]=h*l,t[4]=a*d,t[5]=u*l,t[6]=o*f,t[7]=h*c,t[8]=o*d,t[9]=u*c,t[10]=o*l,t[11]=a*c,o=e[8],a=e[9],u=e[10],h=e[11],c=e[12],l=e[13],d=e[14],f=e[15],i[8]=t[0]*l+t[3]*d+t[4]*f,i[8]-=t[1]*l+t[2]*d+t[5]*f,i[9]=t[1]*c+t[6]*d+t[9]*f,i[9]-=t[0]*c+t[7]*d+t[8]*f,i[10]=t[2]*c+t[7]*l+t[10]*f,i[10]-=t[3]*c+t[6]*l+t[11]*f,i[11]=t[5]*c+t[8]*l+t[11]*d,i[11]-=t[4]*c+t[9]*l+t[10]*d,i[12]=t[2]*u+t[5]*h+t[1]*a,i[12]-=t[4]*h+t[0]*a+t[3]*u,i[13]=t[8]*h+t[0]*o+t[7]*u,i[13]-=t[6]*u+t[9]*h+t[1]*o,i[14]=t[6]*a+t[11]*h+t[3]*o,i[14]-=t[10]*h+t[2]*o+t[7]*a,i[15]=t[10]*u+t[4]*o+t[9]*a,i[15]-=t[8]*a+t[11]*u+t[5]*o;var p=1/(e[0]*i[0]+e[1]*i[1]+e[2]*i[2]+e[3]*i[3]);for(r=0,k=0;4>r;r++)for(var m=this.matrix[r],g=0;4>g;g++)m[g]=i[k++]*p;return this},multiply:function(t){return"number"==typeof t?new o(this).multiply(t):new o(this).multiplySelf(t)},multiplySelf:function(t){var e,i=0;if("number"==typeof t){for(i=0;4>i;i++)e=this.matrix[i],e[0]*=t,e[1]*=t,e[2]*=t,e[3]*=t;return this}var n=t.matrix[0],r=t.matrix[1],s=t.matrix[2],o=t.matrix[3];for(i=0;4>i;i++){e=this.matrix[i];for(var a=0;4>a;a++)this.temp[a]=e[0]*n[a]+e[1]*r[a]+e[2]*s[a]+e[3]*o[a];e[0]=this.temp[0],e[1]=this.temp[1],e[2]=this.temp[2],e[3]=this.temp[3]}return this},rotateAroundAxis:function(t,e){var i,n,r,s,o,u,h,c;return i=t.x,n=t.y,r=t.z,s=Math.sin(e),o=Math.cos(e),u=1-o,h=u*i,c=u*n,a.set(h*i+o,h*n+s*r,h*r-s*n,0,h*n-s*r,c*n+o,c*r+s*i,0,h*r+s*n,c*r-s*i,u*r*r+o,0,0,0,0,1),this.multiplySelf(a)},rotateX:function(t){return a.identity(),a.matrix[1][1]=a.matrix[2][2]=Math.cos(t),a.matrix[2][1]=Math.sin(t),a.matrix[1][2]=-a.matrix[2][1],this.multiplySelf(a)},rotateY:function(t){return a.identity(),a.matrix[0][0]=a.matrix[2][2]=Math.cos(t),a.matrix[0][2]=Math.sin(t),a.matrix[2][0]=-a.matrix[0][2],this.multiplySelf(a)},rotateZ:function(t){return a.identity(),a.matrix[0][0]=a.matrix[1][1]=Math.cos(t),a.matrix[1][0]=Math.sin(t),a.matrix[0][1]=-a.matrix[1][0],this.multiplySelf(a)},scale:function(t,e,i){return new o(this).scaleSelf(t,e,i)},scaleSelf:function(t,e,i){return r.tests.hasXYZ(t)?(e=t.y,i=t.z,t=t.x):(void 0===e||void 0===i)&&(e=t,i=t),a.identity(),a.matrix[0][0]=t,a.matrix[1][1]=e,a.matrix[2][2]=i,this.multiplySelf(a)},set:function(t,e,i,n,r,s,o,a,u,h,c,l,d,f,p,m){var g;if("number"==typeof t)g=this.matrix[0],g[0]=t,g[1]=e,g[2]=i,g[3]=n,g=this.matrix[1],g[0]=r,g[1]=s,g[2]=o,g[3]=a,g=this.matrix[2],g[0]=u,g[1]=h,g[2]=c,g[3]=l,g=this.matrix[3],g[0]=d,g[1]=f,g[2]=p,g[3]=m;else for(var _=0;4>_;_++){g=this.matrix[_];var y=g.matrix[_];g[0]=y[0],g[1]=y[1],g[2]=y[2],g[3]=y[3]}return this},setFrustrum:function(t,e,i,n,r,s){var o=e-t,a=i-n,u=s-r;return this.set(2*r/o,0,(t+e)/o,0,0,2*r/a,(i+n)/a,0,0,0,-(r+s)/u,-2*r*s/u,0,0,-1,0)},setOrtho:function(t,e,i,n,r,s){var o=[2/(e-t),0,0,(t+e)/(e-t),0,2/(i-n),0,(i+n)/(i-n),0,0,-2/(s-r),(s+r)/(s-r),0,0,0,1];return this.set.apply(this,o)},setPerspective:function(t,e,i,r){var s=i*Math.tan(.5*n.radians(t)),o=e*s;return this.setFrustrum(-o,o,s,-s,i,r)},setPosition:function(t,e,i){return this.matrix[0][3]=t,this.matrix[1][3]=e,this.matrix[2][3]=i,this},setScale:function(t,e,i){return this.matrix[0][0]=t,this.matrix[1][1]=e,this.matrix[2][2]=i,this},sub:function(t){return new o(this).subSelf(t)},subSelf:function(t){for(var e=0;4>e;e++){var i=this.matrix[e],n=t.matrix[e];i[0]-=n[0],i[1]-=n[1],i[2]-=n[2],i[3]-=n[3]}return this},toArray:function(t){void 0===t&&(t=[]);for(var e=0,i=0;4>e;e++)for(var n=this.matrix[e],r=0;4>r;r++)t[i++]=n[r];return t},toFloatArray:function(t){return new Float32Array(this.toArray(t))},toString:function(){return"| "+this.matrix[0][0]+" "+this.matrix[0][1]+" "+this.matrix[0][2]+" "+this.matrix[0][3]+" |\n"+"| "+this.matrix[1][0]+" "+this.matrix[1][1]+" "+this.matrix[1][2]+" "+this.matrix[1][3]+" |\n"+"| "+this.matrix[2][0]+" "+this.matrix[2][1]+" "+this.matrix[2][2]+" "+this.matrix[2][3]+" |\n"+"| "+this.matrix[3][0]+" "+this.matrix[3][1]+" "+this.matrix[3][2]+" "+this.matrix[3][3]+" |"},toTransposedFloatArray:function(t){void 0===t&&(t=[]);for(var e=0,i=0;4>e;e++)for(var n=0;4>n;n++)t[i++]=this.matrix[n][e];return t},translate:function(t,e,i){return new o(this).translateSelf(t,e,i)},translateSelf:function(t,e,i){return r.tests.hasXYZ(t)&&(e=t.y,i=t.z,t=t.x),a.identity(),a.setPosition(t,e,i),this.multiplySelf(a)},transpose:function(){return this.set(this.matrix[0][0],this.matrix[1][0],this.matrix[2][0],this.matrix[3][0],this.matrix[0][1],this.matrix[1][1],this.matrix[2][1],this.matrix[3][1],this.matrix[0][2],this.matrix[1][2],this.matrix[2][2],this.matrix[3][2],this.matrix[0][3],this.matrix[1][3],this.matrix[2][3],this.matrix[3][3])}};var a=new o;i.exports=o});